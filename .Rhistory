"CD206.BUV615",     # macrophage/DC mannose receptor
"HLA.DR.BV711",     # APCs (monos/DC/B)
"CD11c.PECF594"     # myeloid DC/monos
)
# Dendritic cell subsets
dc_markers <- c(
"CD1c.APC",         # cDC2
"CD141.BV786",      # cDC1
"CD303.RB545",      # pDC
"CD11c.PECF594",
"HLA.DR.BV711",
"CD80.BV605",
"CD86.BV421",
"CD206.BUV615"      # often on mo-DC/tissue DC
)
# Other / QC / granulocyte-leaning
other_qc_markers <- c(
"Siglec8.CD20.RB744", # eosinophils (Siglec-8) / B (CD20) combo
"CD15.CD3.AF700"      # granulocyte (CD15) / T (CD3) combo
)
marker_sets <- list(
`T` = t_markers,
NK = nk_markers,
B = b_markers,
Myeloid = myeloid_markers,
DC = dc_markers,
Other_QC = other_qc_markers
)
# NK cells
nk_markers <- c(
"CD56.BV750",
"CD16.BUV496",      # also non-classical monocytes
"CD45RA.BV570"      # also naive T/NK
)
marker_sets <- list(
`T` = t_markers,
NK = nk_markers,
B = b_markers,
Myeloid = myeloid_markers,
DC = dc_markers,
Other_QC = other_qc_markers
)
# minimal: one PDF per set, one marker per page
plot_marker_sets_simple <- function(
obj, marker_sets, out_dir,
reduction = "umap", assay = "flow", slot = "data", pt.size = 0.1
){
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
DefaultAssay(obj) <- assay
avail <- rownames(GetAssayData(obj, assay = assay, slot = slot))
invisible(lapply(names(marker_sets), function(set_name){
feats <- intersect(marker_sets[[set_name]], avail)
if (!length(feats)) return(NULL)
pdf(file.path(out_dir, paste0(set_name, "_", reduction, ".pdf")), width = 8, height = 6)
for (f in feats) {
p <- FeaturePlot(obj, features = f, reduction = reduction, slot = slot,
raster = TRUE, pt.size = pt.size) +
ggplot2::ggtitle(paste(set_name, "—", f))
print(p)
}
dev.off()
NULL
}))
}
# minimal: one PDF per set, one marker per page
plot_marker_sets_simple <- function(
obj, marker_sets, out_dir,
reduction = "umap", assay = "flow", slot = "counts", pt.size = 0.1
){
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
DefaultAssay(obj) <- assay
avail <- rownames(GetAssayData(obj, assay = assay, slot = slot))
invisible(lapply(names(marker_sets), function(set_name){
feats <- intersect(marker_sets[[set_name]], avail)
if (!length(feats)) return(NULL)
pdf(file.path(out_dir, paste0(set_name, "_", reduction, ".pdf")), width = 8, height = 6)
for (f in feats) {
p <- FeaturePlot(obj, features = f, reduction = reduction, slot = slot,
raster = TRUE, pt.size = pt.size) +
ggplot2::ggtitle(paste(set_name, "—", f))
print(p)
}
dev.off()
NULL
}))
}
plot_marker_sets_simple(
FCS_AllDays_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets",
reduction = "umap", assay = "flow", slot = "counts", pt.size = 0.1
)
plot_marker_sets_simple(
FCS_AllDays_Day23_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets",
reduction = "umap", assay = "flow", slot = "counts", pt.size = 0.1
)
plot_marker_sets_simple <- function(
obj, marker_sets, out_dir
){
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
lapply(names(marker_sets), function(set_name){
pdf(file.path(out_dir, paste0(set_name, "_", reduction, ".pdf")), width = 8, height = 6)
for (f in feats) {
p <- FeaturePlot(obj, features = f) +
ggplot2::ggtitle(paste(set_name, "—", f))
print(p)
}
dev.off()
NULL
})
}
plot_marker_sets_simple(
FCS_AllDays_Day23_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets"
)
plot_marker_sets_simple <- function(
obj, marker_sets, out_dir
){
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
lapply(names(marker_sets), function(set_name){
pdf(file.path(out_dir, paste0(set_name, ".pdf")), width = 8, height = 6)
for (f in feats) {
p <- FeaturePlot(obj, features = f) +
ggplot2::ggtitle(paste(set_name, "—", f))
print(p)
}
dev.off()
NULL
})
}
plot_marker_sets_simple(
FCS_AllDays_Day23_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets"
)
plot_marker_sets_simple <- function(
obj, marker_sets, out_dir
){
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
lapply(names(marker_sets), function(set_name){
feats <- marker_sets[[set_name]]
pdf(file.path(out_dir, paste0(set_name, ".pdf")), width = 8, height = 6)
for (f in feats) {
p <- FeaturePlot(obj, features = f) +
ggplot2::ggtitle(paste(set_name, "—", f))
print(p)
}
dev.off()
NULL
})
}
plot_marker_sets_simple(
FCS_AllDays_Day23_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets"
)
plot_marker_sets_simple(
FCS_AllDays_Day23_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets"
)
plot_marker_sets_simple <- function(
obj, marker_sets, out_dir
){
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
lapply(names(marker_sets), function(set_name){
feats <- marker_sets[[set_name]]
pdf(file.path(out_dir, paste0(set_name, ".pdf")), width = 8, height = 6)
p <- FeaturePlot(obj, features = feats) +
ggplot2::ggtitle(set_name)
print(p)
dev.off()
NULL
})
}
plot_marker_sets_simple(
FCS_AllDays_Day23_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets"
)
plot_marker_sets_simple <- function(
obj, marker_sets, out_dir
){
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
lapply(names(marker_sets), function(set_name){
feats <- marker_sets[[set_name]]
pdf(file.path(out_dir, paste0(set_name, ".pdf")), width = 16, height = 12)
p <- FeaturePlot(obj, features = feats) +
ggplot2::ggtitle(set_name)
print(p)
dev.off()
NULL
})
}
plot_marker_sets_simple(
FCS_AllDays_Day23_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets"
)
plot_marker_sets_simple <- function(
obj, marker_sets, out_dir
){
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
lapply(names(marker_sets), function(set_name){
feats <- marker_sets[[set_name]]
pdf(file.path(out_dir, paste0(set_name, ".pdf")), width = 16, height = 12)
p <- FeaturePlot(obj, features = feats) +
ggplot2::ggtitle(feats)
print(p)
dev.off()
NULL
})
}
plot_marker_sets_simple(
FCS_AllDays_Day23_HarmGated, marker_sets,
out_dir = "/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/umap_marker_sets"
)
DimPlot(FCS_AllDays_Day23_HarmGated)
clust <- DimPlot(FCS_AllDays_Day23_HarmGated)
ggsave("/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/clusters_FCS_AllDays_Singlets_Day23_HarmonyTheta2.pdf", clust, width = 8, height = 6)
clust <- DimPlot(FCS_AllDays_Day23_HarmGated)
ggsave("/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/clusters_FCS_AllDays_Singlets_Day23_HarmonyTheta2.pdf", clust, width = 8, height = 6)
cd_markers <- c(
"CD303.RB545","CX3CR1.BB700","Siglec8.CD20.RB744","CD163.RB780","CD1c.APC",
"CD15.CD3.AF700","CD14.APCCy7","CD11b.BUV395","CD16.BUV496","CD4.IgD.BUV563",
"CD206.BUV615","CD25.BUV661","CD8.19.BUV737","CD89.BUV805","CD86.BV421",
"CD45RA.BV570","CD80.BV605","CD45RO.BV650","HLA.DR.BV711",
"CD56.BV750","CD141.BV786","CD88.PE","CD11c.PECF594","CCR2.PECy7"
)
DotPlot(FCS_AllDays_Day23_HarmGated, features = cd_markers, group.by = "seurat_clusters") + RotatedAxis()
ggsave("/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/dot_FCS_AllDays_Singlets_Day23_HarmonyTheta2.pdf", dot, width = 8, height = 6)
dot <- DotPlot(FCS_AllDays_Day23_HarmGated, features = cd_markers, group.by = "seurat_clusters") + RotatedAxis()
dot <- DotPlot(FCS_AllDays_Day23_HarmGated, features = cd_markers, group.by = "seurat_clusters") + RotatedAxis()
ggsave("/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/dot_FCS_AllDays_Singlets_Day23_HarmonyTheta2.pdf", dot, width = 8, height = 6)
clust <- DimPlot(FCS_AllDays_Day23_HarmGated, label = TRUE)
ggsave("/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/clusters_FCS_AllDays_Singlets_Day23_HarmonyTheta2.pdf", clust, width = 8, height = 6)
# ---- EDIT THIS: put your labels next to the cluster IDs ----
# start with "UNK" and replace with your calls
cluster_to_label <- c(
"0"  = "CD14",
"1"  = "CD4",
"2"  = "CD45RA",
"4"  = "CD8_CD19",
"5"  = "CD20",
"7"  = "CD14",
"9"  = "CD8_CD19",
"10" = "CD16",
"11" = "CD16",
"12" = "CD56",
"14" = "CCR2",
"15" = "CD86",
"16" = "CD14",
"17" = "CD16",
"18" = "CD303",
"19" = "CD56"
)
# apply mapping -> new metadata column
FCS_AllDays_Day23_HarmGated$cell_type <- unname(cluster_to_label[as.character(clust)])
# apply mapping -> new metadata column
FCS_AllDays_Day23_HarmGated$cell_type <- unname(cluster_to_label[as.character(clust)])
FCS_AllDays_Day23_HarmGated$cell_type <- factor(FCS_AllDays_Day23_HarmGated$cell_type)
# (optional) make cell_type the active identity
Idents(FCS_AllDays_Day23_HarmGated) <- "cell_type"
# quick check
table(FCS_AllDays_Day23_HarmGated$cell_type)
cell <- DimPlot(FCS_AllDays_Day23_HarmGated, reduction = "umap", group.by = "cell_type", label = TRUE)
cell <- DimPlot(FCS_AllDays_Day23_HarmGated, reduction = "umap", group.by = "cell_type", label = TRUE)
ggsave("/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/annotation_FCS_AllDays_Singlets_Day23_HarmonyTheta2.pdf", cell, width = 8, height = 6)
clust <- if ("seurat_clusters" %in% colnames(FCS_AllDays_Day23_HarmGated@meta.data)) {
FCS_AllDays_Day23_HarmGated$seurat_clusters
} else {
Idents(FCS_AllDays_Day23_HarmGated)
}
# unique cluster IDs as character keys
keys <- sort(unique(as.character(clust)))
keys
# ---- EDIT THIS: put your labels next to the cluster IDs ----
# start with "UNK" and replace with your calls
cluster_to_label <- c(
"0"  = "CD14",
"1"  = "CD4",
"2"  = "CD45RA",
"4"  = "CD8_CD19",
"5"  = "CD20",
"7"  = "CD14",
"9"  = "CD8_CD19",
"10" = "CD16",
"11" = "CD16",
"12" = "CD56",
"14" = "CCR2",
"15" = "CD86",
"16" = "CD14",
"17" = "CD16",
"18" = "CD303",
"19" = "CD56"
)
# apply mapping -> new metadata column
FCS_AllDays_Day23_HarmGated$cell_type <- unname(cluster_to_label[as.character(clust)])
FCS_AllDays_Day23_HarmGated$cell_type <- factor(FCS_AllDays_Day23_HarmGated$cell_type)
# (optional) make cell_type the active identity
Idents(FCS_AllDays_Day23_HarmGated) <- "cell_type"
# quick check
table(FCS_AllDays_Day23_HarmGated$cell_type)
cell <- DimPlot(FCS_AllDays_Day23_HarmGated, reduction = "umap", group.by = "cell_type", label = TRUE)
ggsave("/Users/ttm3567/Documents/October2025/IMPACT_Flow_analysis/annotation_FCS_AllDays_Singlets_Day23_HarmonyTheta2.pdf", cell, width = 8, height = 6)
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(Seurat)
library(dplyr)
library(ggplot2)
library(tidyr)
library(BiocManager)
library(speckle)
library(demuxmix)
library(deMULTIplex)
library(cellhashR)
library(zellkonverter)
library(gridExtra)
library(grid)
# BiocManager::install("zellkonverter")
build_flow_seurat <- function(
dir,
project = "FlowIMP",
assay   = "flow",
sample_regex = "IMP\\d+",
# default drops
drop_cols = c("Time","SSC.A","SSC.H","SSC.W"),
arcsinh_cofactor = NULL   # set numeric (e.g., 150 or 5) to transform; NULL = skip
){
req_pkgs <- c("data.table", "stringr", "Seurat", "Matrix")
invisible(lapply(req_pkgs, function(p){
if (!requireNamespace(p, quietly = TRUE)) stop(sprintf("Package '%s' is required.", p))
}))
library(data.table); library(stringr); library(Seurat); library(Matrix)
# only CSV/CSV.GZ (ignores .fcs)
files <- list.files(dir, pattern = "\\.csv(\\.gz)?$", full.names = TRUE, ignore.case = TRUE)
if (!length(files)) stop("No .csv or .csv.gz files found in: ", dir)
sample_ids <- stringr::str_extract(basename(files), sample_regex)
keep <- !is.na(sample_ids)
files <- files[keep]
sample_ids <- sample_ids[keep]
if (!length(files)) stop("No files contained a sample ID matching regex: ", sample_regex)
dflist <- vector("list", length(files))
metalist <- vector("list", length(files))
features_per_file <- vector("list", length(files))
for (i in seq_along(files)) {
dt <- data.table::fread(files[i], data.table = FALSE, showProgress = FALSE)
colnames(dt) <- make.unique(colnames(dt))
# drop requested columns (only if present)
if (!is.null(drop_cols) && length(drop_cols)) {
keep_cols <- setdiff(colnames(dt), intersect(colnames(dt), drop_cols))
dt <- dt[, keep_cols, drop = FALSE]
}
sid <- sample_ids[i]
cell_ids <- sprintf("Cell_%05d_%s", seq_len(nrow(dt)), sid)
rownames(dt) <- cell_ids
# optional arcsinh
if (!is.null(arcsinh_cofactor)) {
cf <- as.numeric(arcsinh_cofactor)
if (!is.na(cf) && cf > 0) {
dt[] <- lapply(dt, function(x) asinh(as.numeric(x) / cf))
}
}
dflist[[i]] <- dt
metalist[[i]] <- data.frame(
sample_id   = rep(sid, length(cell_ids)),
source_file = rep(basename(files[i]), length(cell_ids)),
row.names   = cell_ids,
stringsAsFactors = FALSE
)
features_per_file[[i]] <- colnames(dt)
}
# align features across files (union)
all_features <- Reduce(union, features_per_file)
dflist_aligned <- lapply(dflist, function(df){
miss <- setdiff(all_features, colnames(df))
if (length(miss)) df[, miss] <- NA_real_
df <- df[, all_features, drop = FALSE]
df
})
meta <- do.call(rbind, metalist)
cells_by_feat <- do.call(rbind, dflist_aligned)
stopifnot(identical(rownames(meta), rownames(cells_by_feat)))
cells_by_feat[is.na(cells_by_feat)] <- 0
feat_by_cells <- t(as.matrix(cells_by_feat))
feat_by_cells <- Matrix(feat_by_cells, sparse = TRUE)
seu <- CreateSeuratObject(
counts    = feat_by_cells,
project   = project,
assay     = assay,
meta.data = meta
)
Idents(seu) <- "sample_id"
seu
}
seu_day1 <- build_flow_seurat(
dir = "/Users/ttm3567/Documents/August2025/Downsampled_nongranulocyte_fcs/Day1"
)
# optional: save
saveRDS(seu_day1, file = "/Users/ttm3567/Documents/October2025/Day1/FlowIMP_Day1.rds")
seu_day1 <- readRDS("/Users/ttm3567/Documents/October2025/Day1/FlowIMP_Day1.rds")
View(seu_day1)
gate_singlets <- function(
obj,
A = "FSC.A", H = "FSC.H", W = "FSC.W",
assay = "flow", slot = c("data","counts"),
group_by = "sample_id",
method = c("ratio_mad","mahal"),
# ratio_mad params (robust univariate guards)
k_ratio = 4,      # bounds for FSC.H/FSC.A around its median (± k * MAD)
k_width = 4,      # bounds for FSC.W around its median (± k * MAD)
k_area  = 6,      # optional loose guard on FSC.A (± k * MAD)
# mahal params (ellipsoidal gate in log space)
p_mahal = 0.99,   # keep inside 99% chi-square ellipsoid
subset_singlets = FALSE
){
slot   <- match.arg(slot)
method <- match.arg(method)
# fetch the data
X <- GetAssayData(obj, assay = assay, slot = slot)
feats <- rownames(X)
need  <- c(A, H, W)
if (!all(need %in% feats)) {
stop("Missing FSC features in assay '", assay, "': ",
paste(setdiff(need, feats), collapse = ", "))
}
if (!(group_by %in% colnames(obj@meta.data))) {
stop("group_by column '", group_by, "' not found in meta.data.")
}
# vectors for all cells
a <- as.numeric(X[A, ]); names(a) <- colnames(obj)
h <- as.numeric(X[H, ]); names(h) <- colnames(obj)
w <- as.numeric(X[W, ]); names(w) <- colnames(obj)
eps <- 1e-9
ratio <- h / pmax(a, eps)
# preallocate meta columns
md <- obj@meta.data
md$FSC_ratio           <- ratio
md$FSC_keep_singlet    <- NA
md$FSC_ratio_low       <- NA_real_
md$FSC_ratio_high      <- NA_real_
md$FSCW_low            <- NA_real_
md$FSCW_high           <- NA_real_
md$FSCA_low            <- NA_real_
md$FSCA_high           <- NA_real_
if (method == "mahal") {
md$FSC_mahal_d2      <- NA_real_
md$FSC_mahal_thr     <- NA_real_
}
groups <- md[[group_by]]
for (g in unique(groups)) {
idx <- which(groups == g)
if (method == "ratio_mad") {
r_g <- ratio[idx]; a_g <- a[idx]; w_g <- w[idx]
r_med <- stats::median(r_g, na.rm = TRUE)
r_mad <- stats::mad(r_g, constant = 1, na.rm = TRUE)
r_lo  <- r_med - k_ratio * r_mad
r_hi  <- r_med + k_ratio * r_mad
w_med <- stats::median(w_g, na.rm = TRUE)
w_mad <- stats::mad(w_g, constant = 1, na.rm = TRUE)
w_lo  <- w_med - k_width * w_mad
w_hi  <- w_med + k_width * w_mad
a_med <- stats::median(a_g, na.rm = TRUE)
a_mad <- stats::mad(a_g, constant = 1, na.rm = TRUE)
a_lo  <- a_med - k_area * a_mad
a_hi  <- a_med + k_area * a_mad
keep_g <- (r_g >= r_lo & r_g <= r_hi) &
(w_g >= w_lo & w_g <= w_hi) &
(a_g >= a_lo & a_g <= a_hi)
md$FSC_keep_singlet[idx] <- keep_g
md$FSC_ratio_low[idx]    <- r_lo
md$FSC_ratio_high[idx]   <- r_hi
md$FSCW_low[idx]         <- w_lo
md$FSCW_high[idx]        <- w_hi
md$FSCA_low[idx]         <- a_lo
md$FSCA_high[idx]        <- a_hi
} else { # mahal
Xg <- cbind(
log10(pmax(a[idx], eps)),
log10(pmax(h[idx], eps)),
log10(pmax(w[idx], eps))
)
colnames(Xg) <- c("logA","logH","logW")
mu  <- colMeans(Xg, na.rm = TRUE)
Sig <- stats::cov(Xg, use = "pairwise.complete.obs")
d2  <- stats::mahalanobis(Xg, center = mu, cov = Sig)
thr <- stats::qchisq(p_mahal, df = 3)
keep_g <- is.finite(d2) & (d2 <= thr)
md$FSC_keep_singlet[idx] <- keep_g
md$FSC_mahal_d2[idx]     <- d2
md$FSC_mahal_thr[idx]    <- thr
}
}
# write back
obj@meta.data <- md
# optional subset
if (isTRUE(subset_singlets)) {
obj <- subset(obj, subset = FSC_keep_singlet)
}
obj
}
DefaultAssay(seu_day1) <- "flow"
seu_day1 <- NormalizeData(seu_day1)
seu_day1 <- NormalizeData(seu_day1)
str(seu_day1)
# 1) Ratio+MAD gate (simple & robust)
seu_day1_gated <- gate_singlets(
seu_day1,
method = "ratio_mad",
subset_singlets = TRUE  # set FALSE first if you want to visualize thresholds
)
shiny::runApp('Documents/August2025/BulkWebApp_v4.4_updated_data')
runApp('Documents/November2025/Bulk_GroupfileFormattingApp_v2')
runApp('Documents/November2025/Bulk_GroupfileFormattingApp_v2')
runApp('Documents/November2025/Bulk_GroupfileFormattingApp_v2')
runApp('Documents/November2025/Bulk_GroupfileFormattingApp_v2')
runApp('Documents/November2025/Bulk_GroupfileFormattingApp_v2')
